{
    "AWSTemplateFormatVersion": "2010-09-09", 
    "Conditions": {
        "ConditionSegmentASGs": {
            "Fn::Equals": [
                "yes", 
                "yes"
            ]
        }, 
        "ConditionUseCustomDatabaseLogin": {
            "Fn::Equals": [
                {
                    "Ref": "ParameterOverrideDatabaseLogin"
                }, 
                "yes"
            ]
        }, 
        "ConditionUseCustomEndpoints": {
            "Fn::Equals": [
                {
                    "Ref": "ParameterOverrideEndpoints"
                }, 
                "yes"
            ]
        }, 
        "ConditionUseCustomSecurityGroups": {
            "Fn::Equals": [
                {
                    "Ref": "ParameterOverrideSecurityGroups"
                }, 
                "yes"
            ]
        }, 
        "ConditionUseCustomSubnetGroups": {
            "Fn::Equals": [
                {
                    "Ref": "ParameterOverrideSubnetGroups"
                }, 
                "yes"
            ]
        }, 
        "ConditionUseInstanceProfile": {
            "Fn::Equals": [
                {
                    "Ref": "ParameterOverrideInstanceProfile"
                }, 
                "yes"
            ]
        }, 
        "ConditionUseProxies": {
            "Fn::Equals": [
                {
                    "Ref": "ParameterOverrideProxies"
                }, 
                "yes"
            ]
        }
    }, 
    "Description": "DivvyCloud base deployment for enterprises. This template deploys webserver, scheduler, and workers into different ASGs of different capacity", 
    "Mappings": {
        "CurrentRelease": {
            "current": {
                "release": "v19.4.2"
            }
        }, 
        "Ports": {
            "https": {
                "port": "443"
            }, 
            "instance": {
                "port": "8001"
            }, 
            "loadbalancer": {
                "port": "80"
            }
        }, 
        "RegionMap": {
            "ap-east-1": {
                "64": "ami-d26218a3"
            }, 
            "ap-northeast-1": {
                "64": "ami-0d5db3e2a1b98ca94"
            }, 
            "ap-northeast-2": {
                "64": "ami-0f4362c71ffaf7759"
            }, 
            "ap-northeast-3": {
                "64": "ami-07672d9af3947230d"
            }, 
            "ap-south-1": {
                "64": "ami-0237472cf337d9529"
            }, 
            "ap-southeast-1": {
                "64": "ami-0c199cae95cea87f0"
            }, 
            "ap-southeast-2": {
                "64": "ami-0c0483bc96aef8b2f"
            }, 
            "ca-central-1": {
                "64": "ami-0dbe45195223e250b"
            }, 
            "cn-north-1": {
                "64": "ami-01993b4213b4bffb5"
            }, 
            "cn-northwest-1": {
                "64": "ami-01d4e30d4d4952d0f"
            }, 
            "eu-central-1": {
                "64": "ami-040a1551f9c9d11ad"
            }, 
            "eu-north-1": {
                "64": "ami-0567220a328fe4fee"
            }, 
            "eu-west-1": {
                "64": "ami-0e41581acd7dedd99"
            }, 
            "eu-west-2": {
                "64": "ami-00f94dc949fea2adf"
            }, 
            "eu-west-3": {
                "64": "ami-0df03c7641cf41947"
            }, 
            "me-south-1": {
                "64": "ami-0a7794ed517908686"
            }, 
            "sa-east-1": {
                "64": "ami-0065a65613972a22a"
            }, 
            "us-east-1": {
                "64": "ami-0d5ae5525eb033d0a"
            }, 
            "us-east-2": {
                "64": "ami-0a7f2b5b6b87eaa1b"
            }, 
            "us-gov-east-1": {
                "64": "ami-64a84b15"
            }, 
            "us-gov-west-1": {
                "64": "ami-a76736c6"
            }, 
            "us-west-1": {
                "64": "ami-00a3e4424e9ab3e56"
            }, 
            "us-west-2": {
                "64": "ami-09c6723c6c24250c9"
            }
        }
    }, 
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "EC2 Deployment Information"
                    }, 
                    "Parameters": [
                        "ParameterEmail", 
                        "ParameterKey"
                    ]
                }, 
                {
                    "Label": {
                        "default": "Scaling Options"
                    }, 
                    "Parameters": [
                        "ParameterInstanceType", 
                        "ParameterOverrideASGs", 
                        "ParameterOverrideDesiredCapacity", 
                        "ParameterWorkers", 
                        "ParameterWebserverInstanceType", 
                        "ParameterLoadBalancerPorts", 
                        "ParameterLoadBalancerProtocol", 
                        "ParameterSSLID"
                    ]
                }, 
                {
                    "Label": {
                        "default": "Optional Information Profile"
                    }, 
                    "Parameters": [
                        "ParameterOverrideInstanceProfile", 
                        "ParameterInstanceProfilePath", 
                        "ParameterInstanceProfileRole"
                    ]
                }, 
                {
                    "Label": {
                        "default": "Default Networking and Security Deployment Information"
                    }, 
                    "Parameters": [
                        "ParameterNetworkStackName"
                    ]
                }, 
                {
                    "Label": {
                        "default": "Optional Proxies"
                    }, 
                    "Parameters": [
                        "ParameterOverrideProxies", 
                        "ParameterHttp", 
                        "ParameterHttps"
                    ]
                }, 
                {
                    "Label": {
                        "default": "Optional Security Group Overrides"
                    }, 
                    "Parameters": [
                        "ParameterOverrideSecurityGroups", 
                        "ParameterSecurityGroupDivvyWorkers", 
                        "ParameterSecurityGroupDivvyELB"
                    ]
                }, 
                {
                    "Label": {
                        "default": "Optional Subnet Overrides"
                    }, 
                    "Parameters": [
                        "ParameterOverrideSubnetGroups", 
                        "ParameterSubnetDivvy1of2", 
                        "ParameterSubnetDivvy2of2", 
                        "ParameterAssociatePublicIpAddress"
                    ]
                }, 
                {
                    "Label": {
                        "default": "Default Data Deployment Information"
                    }, 
                    "Parameters": [
                        "ParameterDataStackName"
                    ]
                }, 
                {
                    "Label": {
                        "default": "Optional Database Login Overrides"
                    }, 
                    "Parameters": [
                        "ParameterOverrideDatabaseLogin", 
                        "ParameterOverrideDBusername", 
                        "ParameterOverrideDBpassword"
                    ]
                }, 
                {
                    "Label": {
                        "default": "Optional Database and Redis Endpoint Overrides"
                    }, 
                    "Parameters": [
                        "ParameterOverrideEndpoints", 
                        "ParameterOverrideDBendpoint", 
                        "ParameterOverrideCacheendpoint"
                    ]
                }
            ], 
            "ParameterLabels": {
                "ParameterAssociatePublicIpAddress": {
                    "default": "Worker IP Address Type"
                }, 
                "ParameterDataStackName": {
                    "default": "Data Stack Name"
                }, 
                "ParameterEmail": {
                    "default": "Email Address"
                }, 
                "ParameterHttp": {
                    "default": "HTTP Proxy Setting"
                }, 
                "ParameterHttps": {
                    "default": "HTTPS Proxy Setting"
                }, 
                "ParameterInstanceProfilePath": {
                    "default": "Instance Profile Path"
                }, 
                "ParameterInstanceProfileRole": {
                    "default": "Instance Profile Role Name"
                }, 
                "ParameterInstanceType": {
                    "default": "Worker Instance Type"
                }, 
                "ParameterKey": {
                    "default": "SSH Key Pair"
                }, 
                "ParameterLoadBalancerPorts": {
                    "default": "ELB listener port"
                }, 
                "ParameterLoadBalancerProtocol": {
                    "default": "ELB listener protocol"
                }, 
                "ParameterNetworkStackName": {
                    "default": "Network Stack Name"
                }, 
                "ParameterOverrideASGs": {
                    "default": "ASG config"
                }, 
                "ParameterOverrideCacheendpoint": {
                    "default": "Redis Endpoint"
                }, 
                "ParameterOverrideDBendpoint": {
                    "default": "RDS Endpoint"
                }, 
                "ParameterOverrideDBpassword": {
                    "default": "RDS Password"
                }, 
                "ParameterOverrideDBusername": {
                    "default": "RDS Username"
                }, 
                "ParameterOverrideDatabaseLogin": {
                    "default": "Overide provided RDS Login credentials"
                }, 
                "ParameterOverrideDesiredCapacity": {
                    "default": "Workers ASG desired capacity"
                }, 
                "ParameterOverrideEndpoints": {
                    "default": "Overide provided RDS and Redis Endpoints"
                }, 
                "ParameterOverrideInstanceProfile": {
                    "default": "Add Instance Profiles"
                }, 
                "ParameterOverrideProxies": {
                    "default": "Add Proxy Settings"
                }, 
                "ParameterOverrideSecurityGroups": {
                    "default": "Overide provided Security Groups"
                }, 
                "ParameterOverrideSubnetGroups": {
                    "default": "Overide provided Subnets"
                }, 
                "ParameterSSLID": {
                    "default": "SSL certificate ARN"
                }, 
                "ParameterSecurityGroupDivvyELB": {
                    "default": "Load Balancer Security Group"
                }, 
                "ParameterSecurityGroupDivvyWorkers": {
                    "default": "Workers Security Group"
                }, 
                "ParameterSubnetDivvy1of2": {
                    "default": "Worker Subnet 1"
                }, 
                "ParameterSubnetDivvy2of2": {
                    "default": "Worker Subnet 2"
                }, 
                "ParameterWebserverInstanceType": {
                    "default": "Webserver/Scheduler Instance Type"
                }, 
                "ParameterWorkers": {
                    "default": "Worker Process Per Instance"
                }
            }
        }
    }, 
    "Parameters": {
        "ParameterAssociatePublicIpAddress": {
            "AllowedValues": [
                "true", 
                "false"
            ], 
            "ConstraintDescription": "Must be true or false", 
            "Default": "true", 
            "Description": "Should the workers have public IP addresses?", 
            "Type": "String"
        }, 
        "ParameterDataStackName": {
            "AllowedPattern": "\\S{1,}", 
            "ConstraintDescription": "Stack name cannot be blank", 
            "Default": "Data", 
            "Description": "Name of stack used to deploy data resources | If you're using your own data layer, set login and endpoint overrides to yes and this value will be ignored", 
            "Type": "String"
        }, 
        "ParameterEmail": {
            "AllowedPattern": "\\S+@\\S+", 
            "ConstraintDescription": "Must be valid email address.", 
            "Description": "Email address to receive EC2 launch notifications", 
            "Type": "String"
        }, 
        "ParameterHttp": {
            "Default": "Enter IP address with port if adding proxy", 
            "Description": "HTTP address of proxy server", 
            "Type": "String"
        }, 
        "ParameterHttps": {
            "Default": "Enter IP address with port if adding proxy", 
            "Description": "HTTPS address of proxy server", 
            "Type": "String"
        }, 
        "ParameterInstanceProfilePath": {
            "Default": "/", 
            "Description": "Path for Instance Profile", 
            "Type": "String"
        }, 
        "ParameterInstanceProfileRole": {
            "Default": "Enter role name to associate with instance profile", 
            "Description": "Role Name for Instance Profile", 
            "Type": "String"
        }, 
        "ParameterInstanceType": {
            "AllowedValues": [
                "c4.xlarge", 
                "c4.2xlarge", 
                "c5.xlarge", 
                "c5.2xlarge", 
                "m5.xlarge"
            ], 
            "ConstraintDescription": "Must be a valid EC2 HVM instance type for your AWS AZs.", 
            "Default": "c5.xlarge", 
            "Description": "EC2 HVM instance type (e.g., c5.xlarge, etc.).", 
            "Type": "String"
        }, 
        "ParameterKey": {
            "AllowedPattern": "\\S{1,}", 
            "ConstraintDescription": "Must be the name of an existing EC2 KeyPair in this Region.", 
            "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instance", 
            "Type": "AWS::EC2::KeyPair::KeyName"
        }, 
        "ParameterLoadBalancerPorts": {
            "AllowedValues": [
                "80", 
                "443"
            ], 
            "ConstraintDescription": "Must be 80 or 443", 
            "Default": "80", 
            "Description": "Which port should the load balancer listen on?", 
            "Type": "String"
        }, 
        "ParameterLoadBalancerProtocol": {
            "AllowedValues": [
                "HTTP", 
                "HTTPS"
            ], 
            "ConstraintDescription": "Must be HTTP or HTTPS", 
            "Default": "HTTP", 
            "Description": "Which protocol should the load balancer use?", 
            "Type": "String"
        }, 
        "ParameterNetworkStackName": {
            "AllowedPattern": "\\S{1,}", 
            "ConstraintDescription": "Stack name cannot be blank", 
            "Default": "Network", 
            "Description": "Name of stack used to deploy network resources | If you're using your own VPC, set subnet and security overrides to yes and this value will be ignored", 
            "Type": "String"
        }, 
        "ParameterOverrideCacheendpoint": {
            "Default": "Enter value if override", 
            "Description": "Redis endpoint", 
            "Type": "String"
        }, 
        "ParameterOverrideDBendpoint": {
            "Default": "Enter value if Override", 
            "Description": "RDS endpoint", 
            "Type": "String"
        }, 
        "ParameterOverrideDBpassword": {
            "Default": "Enter value if Override", 
            "Description": "RDS password", 
            "Type": "String"
        }, 
        "ParameterOverrideDBusername": {
            "Default": "Enter value if Override", 
            "Description": "RDS username", 
            "Type": "String"
        }, 
        "ParameterOverrideDatabaseLogin": {
            "AllowedValues": [
                "yes", 
                "no"
            ], 
            "ConstraintDescription": "Must be yes or no", 
            "Default": "no", 
            "Description": "Override RDS login credentials?", 
            "Type": "String"
        }, 
        "ParameterOverrideDesiredCapacity": {
            "AllowedValues": [
                "2", 
                "3", 
                "4", 
                "5", 
                "6", 
                "7", 
                "8"
            ], 
            "ConstraintDescription": "Must be between 1 and 8", 
            "Default": "2", 
            "Description": "Used for separate Workers ASG", 
            "Type": "String"
        }, 
        "ParameterOverrideEndpoints": {
            "AllowedValues": [
                "yes", 
                "no"
            ], 
            "ConstraintDescription": "Must be yes or no", 
            "Default": "no", 
            "Description": "Override deployed RDS and Redis endpoints?", 
            "Type": "String"
        }, 
        "ParameterOverrideInstanceProfile": {
            "AllowedValues": [
                "yes", 
                "no"
            ], 
            "ConstraintDescription": "Must be yes or no", 
            "Default": "no", 
            "Description": "Using an Instance Profile?", 
            "Type": "String"
        }, 
        "ParameterOverrideProxies": {
            "AllowedValues": [
                "yes", 
                "no"
            ], 
            "ConstraintDescription": "Must be yes or no", 
            "Default": "no", 
            "Description": "Add Proxy settings?", 
            "Type": "String"
        }, 
        "ParameterOverrideSecurityGroups": {
            "AllowedValues": [
                "yes", 
                "no"
            ], 
            "ConstraintDescription": "Must be yes or no", 
            "Default": "no", 
            "Description": "Override deployed security groups with provided security groups? | If you're using your own VPC, select yes", 
            "Type": "String"
        }, 
        "ParameterOverrideSubnetGroups": {
            "AllowedValues": [
                "yes", 
                "no"
            ], 
            "ConstraintDescription": "Must be yes or no", 
            "Default": "no", 
            "Description": "Override deployed subnet groups with provided subnet groups? | If you're using your own VPC, select yes", 
            "Type": "String"
        }, 
        "ParameterSSLID": {
            "Default": "If HTTPS/443, enter certificate ARN", 
            "Description": "SSL certificate ARN", 
            "Type": "String"
        }, 
        "ParameterSecurityGroupDivvyELB": {
            "Default": "Enter value if Override", 
            "Description": "Group ID of security group for load balancer", 
            "Type": "String"
        }, 
        "ParameterSecurityGroupDivvyWorkers": {
            "Default": "Enter value if Override", 
            "Description": "Group ID of security group for workers", 
            "Type": "String"
        }, 
        "ParameterSubnetDivvy1of2": {
            "Default": "Enter value if Override", 
            "Description": "Subnet ID of subnet 1 for workers", 
            "Type": "String"
        }, 
        "ParameterSubnetDivvy2of2": {
            "Default": "Enter value if Override", 
            "Description": "Subnet ID of subnet 2 for workers", 
            "Type": "String"
        }, 
        "ParameterWebserverInstanceType": {
            "AllowedValues": [
                "c4.large", 
                "c4.xlarge", 
                "c5.large", 
                "c5.xlarge", 
                "m5.xlarge"
            ], 
            "ConstraintDescription": "Must be a valid EC2 HVM instance type for your AWS AZs.", 
            "Default": "c5.large", 
            "Description": "EC2 HVM instance type (e.g., c4.large, c5.xlarge, etc.).", 
            "Type": "String"
        }, 
        "ParameterWorkers": {
            "AllowedValues": [
                "8", 
                "10", 
                "12", 
                "14", 
                "16"
            ], 
            "ConstraintDescription": "Valid range even numbers between 8 and 16 inclusive.", 
            "Default": "8", 
            "Description": "Used for separate Workers ASG", 
            "Type": "String"
        }
    }, 
    "Resources": {
        "AutoScalingGroupDivvy": {
            "DependsOn": [
                "LaunchConfigurationDivvy", 
                "LoadBalancerDivvy", 
                "TopicDivvySNS"
            ], 
            "Properties": {
                "AutoScalingGroupName": "DivvyASG", 
                "DesiredCapacity": "2", 
                "LaunchConfigurationName": {
                    "Ref": "LaunchConfigurationDivvy"
                }, 
                "LoadBalancerNames": [
                    {
                        "Ref": "LoadBalancerDivvy"
                    }
                ], 
                "MaxSize": "2", 
                "MinSize": "2", 
                "NotificationConfigurations": [
                    {
                        "NotificationTypes": [
                            "autoscaling:EC2_INSTANCE_LAUNCH", 
                            "autoscaling:EC2_INSTANCE_LAUNCH_ERROR", 
                            "autoscaling:EC2_INSTANCE_TERMINATE", 
                            "autoscaling:EC2_INSTANCE_TERMINATE_ERROR"
                        ], 
                        "TopicARN": {
                            "Ref": "TopicDivvySNS"
                        }
                    }
                ], 
                "Tags": [
                    {
                        "Key": "Name", 
                        "PropagateAtLaunch": "true", 
                        "Value": "DivvyCloudWebserver"
                    }
                ], 
                "VPCZoneIdentifier": [
                    {
                        "Fn::If": [
                            "ConditionUseCustomSubnetGroups", 
                            {
                                "Ref": "ParameterSubnetDivvy1of2"
                            }, 
                            {
                                "Fn::ImportValue": {
                                    "Fn::Sub": "${ParameterNetworkStackName}:SubnetDivvy1of2"
                                }
                            }
                        ]
                    }, 
                    {
                        "Fn::If": [
                            "ConditionUseCustomSubnetGroups", 
                            {
                                "Ref": "ParameterSubnetDivvy2of2"
                            }, 
                            {
                                "Fn::ImportValue": {
                                    "Fn::Sub": "${ParameterNetworkStackName}:SubnetDivvy2of2"
                                }
                            }
                        ]
                    }
                ]
            }, 
            "Type": "AWS::AutoScaling::AutoScalingGroup"
        }, 
        "AutoScalingGroupScheduler": {
            "Condition": "ConditionSegmentASGs", 
            "DependsOn": [
                "LaunchConfigurationScheduler", 
                "TopicDivvySNS"
            ], 
            "Properties": {
                "AutoScalingGroupName": "SchedulerASG", 
                "DesiredCapacity": "1", 
                "LaunchConfigurationName": {
                    "Ref": "LaunchConfigurationScheduler"
                }, 
                "MaxSize": "1", 
                "MinSize": "1", 
                "NotificationConfigurations": [
                    {
                        "NotificationTypes": [
                            "autoscaling:EC2_INSTANCE_LAUNCH", 
                            "autoscaling:EC2_INSTANCE_LAUNCH_ERROR", 
                            "autoscaling:EC2_INSTANCE_TERMINATE", 
                            "autoscaling:EC2_INSTANCE_TERMINATE_ERROR"
                        ], 
                        "TopicARN": {
                            "Ref": "TopicDivvySNS"
                        }
                    }
                ], 
                "Tags": [
                    {
                        "Key": "Name", 
                        "PropagateAtLaunch": "true", 
                        "Value": "DivvyCloudScheduler"
                    }
                ], 
                "VPCZoneIdentifier": [
                    {
                        "Fn::If": [
                            "ConditionUseCustomSubnetGroups", 
                            {
                                "Ref": "ParameterSubnetDivvy1of2"
                            }, 
                            {
                                "Fn::ImportValue": {
                                    "Fn::Sub": "${ParameterNetworkStackName}:SubnetDivvy1of2"
                                }
                            }
                        ]
                    }
                ]
            }, 
            "Type": "AWS::AutoScaling::AutoScalingGroup"
        }, 
        "AutoScalingGroupWorkers": {
            "Condition": "ConditionSegmentASGs", 
            "DependsOn": [
                "LaunchConfigurationWorkers", 
                "TopicDivvySNS"
            ], 
            "Properties": {
                "AutoScalingGroupName": "WorkersASG", 
                "DesiredCapacity": {
                    "Ref": "ParameterOverrideDesiredCapacity"
                }, 
                "LaunchConfigurationName": {
                    "Ref": "LaunchConfigurationWorkers"
                }, 
                "MaxSize": "8", 
                "MinSize": "2", 
                "NotificationConfigurations": [
                    {
                        "NotificationTypes": [
                            "autoscaling:EC2_INSTANCE_LAUNCH", 
                            "autoscaling:EC2_INSTANCE_LAUNCH_ERROR", 
                            "autoscaling:EC2_INSTANCE_TERMINATE", 
                            "autoscaling:EC2_INSTANCE_TERMINATE_ERROR"
                        ], 
                        "TopicARN": {
                            "Ref": "TopicDivvySNS"
                        }
                    }
                ], 
                "Tags": [
                    {
                        "Key": "Name", 
                        "PropagateAtLaunch": "true", 
                        "Value": "DivvyCloudWorkers"
                    }
                ], 
                "VPCZoneIdentifier": [
                    {
                        "Fn::If": [
                            "ConditionUseCustomSubnetGroups", 
                            {
                                "Ref": "ParameterSubnetDivvy1of2"
                            }, 
                            {
                                "Fn::ImportValue": {
                                    "Fn::Sub": "${ParameterNetworkStackName}:SubnetDivvy1of2"
                                }
                            }
                        ]
                    }, 
                    {
                        "Fn::If": [
                            "ConditionUseCustomSubnetGroups", 
                            {
                                "Ref": "ParameterSubnetDivvy2of2"
                            }, 
                            {
                                "Fn::ImportValue": {
                                    "Fn::Sub": "${ParameterNetworkStackName}:SubnetDivvy2of2"
                                }
                            }
                        ]
                    }
                ]
            }, 
            "Type": "AWS::AutoScaling::AutoScalingGroup"
        }, 
        "InstanceProfileDivvy": {
            "Condition": "ConditionUseInstanceProfile", 
            "Properties": {
                "Path": {
                    "Ref": "ParameterInstanceProfilePath"
                }, 
                "Roles": [
                    {
                        "Ref": "ParameterInstanceProfileRole"
                    }
                ]
            }, 
            "Type": "AWS::IAM::InstanceProfile"
        }, 
        "LaunchConfigurationDivvy": {
            "Properties": {
                "AssociatePublicIpAddress": {
                    "Ref": "ParameterAssociatePublicIpAddress"
                }, 
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1", 
                        "Ebs": {
                            "VolumeSize": "50", 
                            "VolumeType": "gp2"
                        }
                    }
                ], 
                "EbsOptimized": "true", 
                "IamInstanceProfile": {
                    "Fn::If": [
                        "ConditionUseInstanceProfile", 
                        {
                            "Ref": "InstanceProfileDivvy"
                        }, 
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                }, 
                "ImageId": {
                    "Fn::FindInMap": [
                        "RegionMap", 
                        {
                            "Ref": "AWS::Region"
                        }, 
                        "64"
                    ]
                }, 
                "InstanceMonitoring": "true", 
                "InstanceType": {
                    "Fn::If": [
                        "ConditionSegmentASGs", 
                        {
                            "Ref": "ParameterWebserverInstanceType"
                        }, 
                        {
                            "Ref": "ParameterInstanceType"
                        }
                    ]
                }, 
                "KeyName": {
                    "Ref": "ParameterKey"
                }, 
                "SecurityGroups": [
                    {
                        "Fn::If": [
                            "ConditionUseCustomSecurityGroups", 
                            {
                                "Ref": "ParameterSecurityGroupDivvyWorkers"
                            }, 
                            {
                                "Fn::ImportValue": {
                                    "Fn::Sub": "${ParameterNetworkStackName}:SecurityGroupDivvyWorkers"
                                }
                            }
                        ]
                    }
                ], 
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "\n", 
                            [
                                "#!/bin/bash -xe", 
                                "apt-get update", 
                                "DEBIAN_FRONTEND=noninteractive apt-get upgrade -yq", 
                                "apt-get install -y mysql-client unzip awscli", 
                                "curl -s https://s3.amazonaws.com/get.divvycloud.com/prod.html | bash", 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_DB_HOST=mysql|DIVVY_DB_HOST=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomEndpoints", 
                                                    {
                                                        "Ref": "ParameterOverrideDBendpoint"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBendpoint"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_DB_USERNAME=divvy|DIVVY_DB_USERNAME=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBusername"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBusername"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_DB_PASSWORD=divvy|DIVVY_DB_PASSWORD=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBpassword"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBpassword"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_SECRET_DB_HOST=mysql|DIVVY_SECRET_DB_HOST=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomEndpoints", 
                                                    {
                                                        "Ref": "ParameterOverrideDBendpoint"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBendpoint"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_SECRET_DB_USERNAME=divvy|DIVVY_SECRET_DB_USERNAME=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBusername"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBusername"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_SECRET_DB_PASSWORD=divvy|DIVVY_SECRET_DB_PASSWORD=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBpassword"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBpassword"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_REDIS_HOST=redis|DIVVY_REDIS_HOST=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomEndpoints", 
                                                    {
                                                        "Ref": "ParameterOverrideCacheendpoint"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterCacheendpoint"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::If": [
                                        "ConditionUseProxies", 
                                        {
                                            "Fn::Join": [
                                                "", 
                                                [
                                                    "sed -i 's|#http_proxy=http://proxy.acmecorp.com|http_proxy=", 
                                                    {
                                                        "Ref": "ParameterHttp"
                                                    }, 
                                                    "|g' /divvycloud/prod.env"
                                                ]
                                            ]
                                        }, 
                                        ""
                                    ]
                                }, 
                                {
                                    "Fn::If": [
                                        "ConditionUseProxies", 
                                        {
                                            "Fn::Join": [
                                                "", 
                                                [
                                                    "sed -i 's|#https_proxy=http://proxy.acmecorp.com|https_proxy=", 
                                                    {
                                                        "Ref": "ParameterHttps"
                                                    }, 
                                                    "|g' /divvycloud/prod.env"
                                                ]
                                            ]
                                        }, 
                                        ""
                                    ]
                                }, 
                                {
                                    "Fn::If": [
                                        "ConditionUseProxies", 
                                        "sed -i 's|#no_proxy=mysql,redis,169.254.169.254|no_proxy=mysql,redis,169.254.169.254|g' /divvycloud/prod.env", 
                                        ""
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "mysql -h ", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomEndpoints", 
                                                    {
                                                        "Ref": "ParameterOverrideDBendpoint"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBendpoint"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            " -u ", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBusername"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBusername"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            " -p", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBpassword"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBpassword"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            " -e \"CREATE DATABASE IF NOT EXISTS divvykeys;\""
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::If": [
                                        "ConditionSegmentASGs", 
                                        "sed -i '21,$d' /divvycloud/docker-compose.yml", 
                                        ""
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's/divvycloud:latest/divvycloud:", 
                                            {
                                                "Fn::FindInMap": [
                                                    "CurrentRelease", 
                                                    "current", 
                                                    "release"
                                                ]
                                            }, 
                                            "/g' /divvycloud/docker-compose.yml"
                                        ]
                                    ]
                                }, 
                                "aws s3 cp --recursive s3://supersecretdatabucket123/plugins/ /divvycloud/plugins",
                                "cd /divvycloud/plugins",
                                "unzip '*.zip'",
                                "rm *.zip",
                                "/usr/local/bin/docker-compose -f /divvycloud/docker-compose.yml up -d", 
                                "cat<<EOF> /etc/cron.weekly/remove-docker-images", 
                                "#!/bin/sh", 
                                "# Clean up docker-images", 
                                "docker image prune -f", 
                                "EOF", 
                                "chmod 755 /etc/cron.weekly/remove-docker-images"
                            ]
                        ]
                    }
                }
            }, 
            "Type": "AWS::AutoScaling::LaunchConfiguration"
        }, 
        "LaunchConfigurationScheduler": {
            "Condition": "ConditionSegmentASGs", 
            "Properties": {
                "AssociatePublicIpAddress": {
                    "Ref": "ParameterAssociatePublicIpAddress"
                }, 
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1", 
                        "Ebs": {
                            "VolumeSize": "50", 
                            "VolumeType": "gp2"
                        }
                    }
                ], 
                "EbsOptimized": "true", 
                
                "ImageId": {
                    "Fn::FindInMap": [
                        "RegionMap", 
                        {
                            "Ref": "AWS::Region"
                        }, 
                        "64"
                    ]
                }, 
                "InstanceMonitoring": "true", 
                "InstanceType": {
                    "Ref": "ParameterWebserverInstanceType"
                }, 
                "KeyName": {
                    "Ref": "ParameterKey"
                }, 
                "SecurityGroups": [
                    {
                        "Fn::If": [
                            "ConditionUseCustomSecurityGroups", 
                            {
                                "Ref": "ParameterSecurityGroupDivvyWorkers"
                            }, 
                            {
                                "Fn::ImportValue": {
                                    "Fn::Sub": "${ParameterNetworkStackName}:SecurityGroupDivvyWorkers"
                                }
                            }
                        ]
                    }
                ], 
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "\n", 
                            [
                                "#!/bin/bash -xe", 
                                "apt-get update", 
                                "DEBIAN_FRONTEND=noninteractive apt-get upgrade -yq", 
                                "apt-get install -y mysql-client unzip awscli", 
                                "curl -s https://s3.amazonaws.com/get.divvycloud.com/prod.html | bash", 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_DB_HOST=mysql|DIVVY_DB_HOST=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomEndpoints", 
                                                    {
                                                        "Ref": "ParameterOverrideDBendpoint"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBendpoint"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_DB_USERNAME=divvy|DIVVY_DB_USERNAME=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBusername"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBusername"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_DB_PASSWORD=divvy|DIVVY_DB_PASSWORD=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBpassword"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBpassword"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_SECRET_DB_HOST=mysql|DIVVY_SECRET_DB_HOST=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomEndpoints", 
                                                    {
                                                        "Ref": "ParameterOverrideDBendpoint"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBendpoint"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_SECRET_DB_USERNAME=divvy|DIVVY_SECRET_DB_USERNAME=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBusername"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBusername"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_SECRET_DB_PASSWORD=divvy|DIVVY_SECRET_DB_PASSWORD=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBpassword"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBpassword"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_REDIS_HOST=redis|DIVVY_REDIS_HOST=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomEndpoints", 
                                                    {
                                                        "Ref": "ParameterOverrideCacheendpoint"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterCacheendpoint"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::If": [
                                        "ConditionUseProxies", 
                                        {
                                            "Fn::Join": [
                                                "", 
                                                [
                                                    "sed -i 's|#http_proxy=http://proxy.acmecorp.com|http_proxy=", 
                                                    {
                                                        "Ref": "ParameterHttp"
                                                    }, 
                                                    "|g' /divvycloud/prod.env"
                                                ]
                                            ]
                                        }, 
                                        ""
                                    ]
                                }, 
                                {
                                    "Fn::If": [
                                        "ConditionUseProxies", 
                                        {
                                            "Fn::Join": [
                                                "", 
                                                [
                                                    "sed -i 's|#https_proxy=http://proxy.acmecorp.com|https_proxy=", 
                                                    {
                                                        "Ref": "ParameterHttps"
                                                    }, 
                                                    "|g' /divvycloud/prod.env"
                                                ]
                                            ]
                                        }, 
                                        ""
                                    ]
                                }, 
                                {
                                    "Fn::If": [
                                        "ConditionUseProxies", 
                                        "sed -i 's|#no_proxy=mysql,redis,169.254.169.254|no_proxy=mysql,redis,169.254.169.254|g' /divvycloud/prod.env", 
                                        ""
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "mysql -h ", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomEndpoints", 
                                                    {
                                                        "Ref": "ParameterOverrideDBendpoint"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBendpoint"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            " -u ", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBusername"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBusername"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            " -p", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBpassword"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBpassword"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            " -e \"CREATE DATABASE IF NOT EXISTS divvykeys;\""
                                        ]
                                    ]
                                }, 
                                "sed -i '37,$d' /divvycloud/docker-compose.yml", 
                                "sed -i '3,20d' /divvycloud/docker-compose.yml", 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's/divvycloud:latest/divvycloud:", 
                                            {
                                                "Fn::FindInMap": [
                                                    "CurrentRelease", 
                                                    "current", 
                                                    "release"
                                                ]
                                            }, 
                                            "/g' /divvycloud/docker-compose.yml"
                                        ]
                                    ]
                                }, 
                                "aws s3 cp --recursive s3://supersecretdatabucket123/plugins/ /divvycloud/plugins",
                                "cd /divvycloud/plugins",
                                "unzip '*.zip'",
                                "rm *.zip",
                                "/usr/local/bin/docker-compose -f /divvycloud/docker-compose.yml up -d", 
                                "cat<<EOF> /etc/cron.weekly/remove-docker-images", 
                                "#!/bin/sh", 
                                "# Clean up docker-images", 
                                "docker image prune -f", 
                                "EOF", 
                                "chmod 755 /etc/cron.weekly/remove-docker-images"
                            ]
                        ]
                    }
                }
            }, 
            "Type": "AWS::AutoScaling::LaunchConfiguration"
        }, 
        "LaunchConfigurationWorkers": {
            "Condition": "ConditionSegmentASGs", 
            "Properties": {
                "AssociatePublicIpAddress": {
                    "Ref": "ParameterAssociatePublicIpAddress"
                }, 
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1", 
                        "Ebs": {
                            "VolumeSize": "50", 
                            "VolumeType": "gp2"
                        }
                    }
                ], 
                "EbsOptimized": "true", 
                "IamInstanceProfile": {
                    "Fn::If": [
                        "ConditionUseInstanceProfile", 
                        {
                            "Ref": "InstanceProfileDivvy"
                        }, 
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                }, 
                "ImageId": {
                    "Fn::FindInMap": [
                        "RegionMap", 
                        {
                            "Ref": "AWS::Region"
                        }, 
                        "64"
                    ]
                }, 
                "InstanceMonitoring": "true", 
                "InstanceType": {
                    "Ref": "ParameterInstanceType"
                }, 
                "KeyName": {
                    "Ref": "ParameterKey"
                }, 
                "SecurityGroups": [
                    {
                        "Fn::If": [
                            "ConditionUseCustomSecurityGroups", 
                            {
                                "Ref": "ParameterSecurityGroupDivvyWorkers"
                            }, 
                            {
                                "Fn::ImportValue": {
                                    "Fn::Sub": "${ParameterNetworkStackName}:SecurityGroupDivvyWorkers"
                                }
                            }
                        ]
                    }
                ], 
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "\n", 
                            [
                                "#!/bin/bash -xe", 
                                "apt-get update", 
                                "DEBIAN_FRONTEND=noninteractive apt-get upgrade -yq", 
                                "apt-get install -y mysql-client unzip awscli", 
                                "curl -s https://s3.amazonaws.com/get.divvycloud.com/prod.html | bash", 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_DB_HOST=mysql|DIVVY_DB_HOST=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomEndpoints", 
                                                    {
                                                        "Ref": "ParameterOverrideDBendpoint"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBendpoint"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_DB_USERNAME=divvy|DIVVY_DB_USERNAME=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBusername"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBusername"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_DB_PASSWORD=divvy|DIVVY_DB_PASSWORD=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBpassword"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBpassword"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_SECRET_DB_HOST=mysql|DIVVY_SECRET_DB_HOST=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomEndpoints", 
                                                    {
                                                        "Ref": "ParameterOverrideDBendpoint"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBendpoint"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_SECRET_DB_USERNAME=divvy|DIVVY_SECRET_DB_USERNAME=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBusername"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBusername"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_SECRET_DB_PASSWORD=divvy|DIVVY_SECRET_DB_PASSWORD=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBpassword"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBpassword"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|DIVVY_REDIS_HOST=redis|DIVVY_REDIS_HOST=", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomEndpoints", 
                                                    {
                                                        "Ref": "ParameterOverrideCacheendpoint"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterCacheendpoint"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            "|g' /divvycloud/prod.env"
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::If": [
                                        "ConditionUseProxies", 
                                        {
                                            "Fn::Join": [
                                                "", 
                                                [
                                                    "sed -i 's|#http_proxy=http://proxy.acmecorp.com|http_proxy=", 
                                                    {
                                                        "Ref": "ParameterHttp"
                                                    }, 
                                                    "|g' /divvycloud/prod.env"
                                                ]
                                            ]
                                        }, 
                                        ""
                                    ]
                                }, 
                                {
                                    "Fn::If": [
                                        "ConditionUseProxies", 
                                        {
                                            "Fn::Join": [
                                                "", 
                                                [
                                                    "sed -i 's|#https_proxy=http://proxy.acmecorp.com|https_proxy=", 
                                                    {
                                                        "Ref": "ParameterHttps"
                                                    }, 
                                                    "|g' /divvycloud/prod.env"
                                                ]
                                            ]
                                        }, 
                                        ""
                                    ]
                                }, 
                                {
                                    "Fn::If": [
                                        "ConditionUseProxies", 
                                        "sed -i 's|#no_proxy=mysql,redis,169.254.169.254|no_proxy=mysql,redis,169.254.169.254|g' /divvycloud/prod.env", 
                                        ""
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "mysql -h ", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomEndpoints", 
                                                    {
                                                        "Ref": "ParameterOverrideDBendpoint"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBendpoint"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            " -u ", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBusername"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBusername"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            " -p", 
                                            {
                                                "Fn::If": [
                                                    "ConditionUseCustomDatabaseLogin", 
                                                    {
                                                        "Ref": "ParameterOverrideDBpassword"
                                                    }, 
                                                    {
                                                        "Fn::ImportValue": {
                                                            "Fn::Sub": "${ParameterDataStackName}:ParameterDBpassword"
                                                        }
                                                    }
                                                ]
                                            }, 
                                            " -e \"CREATE DATABASE IF NOT EXISTS divvykeys;\""
                                        ]
                                    ]
                                }, 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's|scale: 8|scale: ", 
                                            {
                                                "Ref": "ParameterWorkers"
                                            }, 
                                            "|g' /divvycloud/docker-compose.yml"
                                        ]
                                    ]
                                }, 
                                "sed -i '3,36d' /divvycloud/docker-compose.yml", 
                                {
                                    "Fn::Join": [
                                        "", 
                                        [
                                            "sed -i 's/divvycloud:latest/divvycloud:", 
                                            {
                                                "Fn::FindInMap": [
                                                    "CurrentRelease", 
                                                    "current", 
                                                    "release"
                                                ]
                                            }, 
                                            "/g' /divvycloud/docker-compose.yml"
                                        ]
                                    ]
                                }, 
                                "aws s3 cp --recursive s3://supersecretdatabucket123/plugins/ /divvycloud/plugins",
                                "cd /divvycloud/plugins",
                                "unzip '*.zip'",
                                "rm *.zip",
                                "/usr/local/bin/docker-compose -f /divvycloud/docker-compose.yml up -d", 
                                "cat<<EOF> /etc/cron.weekly/remove-docker-images", 
                                "#!/bin/sh", 
                                "# Clean up docker-images", 
                                "docker image prune -f", 
                                "EOF", 
                                "chmod 755 /etc/cron.weekly/remove-docker-images"
                            ]
                        ]
                    }
                }
            }, 
            "Type": "AWS::AutoScaling::LaunchConfiguration"
        }, 
        "LoadBalancerDivvy": {
            "Properties": {
                "ConnectionDrainingPolicy": {
                    "Enabled": "true", 
                    "Timeout": "300"
                }, 
                "ConnectionSettings": {
                    "IdleTimeout": "600"
                }, 
                "CrossZone": "true", 
                "HealthCheck": {
                    "HealthyThreshold": "3", 
                    "Interval": "20", 
                    "Target": "HTTP:8001/Status", 
                    "Timeout": "10", 
                    "UnhealthyThreshold": "3"
                }, 
                "Listeners": [
                    {
                        "InstancePort": {
                            "Fn::FindInMap": [
                                "Ports", 
                                "instance", 
                                "port"
                            ]
                        }, 
                        "InstanceProtocol": "HTTP", 
                        "LoadBalancerPort": {
                            "Ref": "ParameterLoadBalancerPorts"
                        }, 
                        "Protocol": {
                            "Ref": "ParameterLoadBalancerProtocol"
                        }, 
                        "SSLCertificateId": {
                            "Ref": "ParameterSSLID"
                        }
                    }
                ], 
                "LoadBalancerName": "Divvycloud-ELB", 
                "Scheme": "internet-facing", 
                "SecurityGroups": [
                    {
                        "Fn::If": [
                            "ConditionUseCustomSecurityGroups", 
                            {
                                "Ref": "ParameterSecurityGroupDivvyELB"
                            }, 
                            {
                                "Fn::ImportValue": {
                                    "Fn::Sub": "${ParameterNetworkStackName}:SecurityGroupDivvyELB"
                                }
                            }
                        ]
                    }
                ], 
                "Subnets": [
                    {
                        "Fn::If": [
                            "ConditionUseCustomSubnetGroups", 
                            {
                                "Ref": "ParameterSubnetDivvy1of2"
                            }, 
                            {
                                "Fn::ImportValue": {
                                    "Fn::Sub": "${ParameterNetworkStackName}:SubnetDivvy1of2"
                                }
                            }
                        ]
                    }, 
                    {
                        "Fn::If": [
                            "ConditionUseCustomSubnetGroups", 
                            {
                                "Ref": "ParameterSubnetDivvy2of2"
                            }, 
                            {
                                "Fn::ImportValue": {
                                    "Fn::Sub": "${ParameterNetworkStackName}:SubnetDivvy2of2"
                                }
                            }
                        ]
                    }
                ]
            }, 
            "Type": "AWS::ElasticLoadBalancing::LoadBalancer"
        }, 
        "TopicDivvySNS": {
            "Properties": {
                "Subscription": [
                    {
                        "Endpoint": {
                            "Ref": "ParameterEmail"
                        }, 
                        "Protocol": "email"
                    }
                ]
            }, 
            "Type": "AWS::SNS::Topic"
        }
    }
}